---
title: "lab_05"
author: "derek willis"
date: "10/18/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## You will need

- Tabula

## Load libraries and establish settings

```{r}
# Turn off scientific notation
options(scipen=999)

# Load the tidyverse.
library(tidyverse)
library(janitor)
```

## Get Our PDF

We'll be working with the [Maryland historical health trend data](https://health.maryland.gov/vsa/Documents/Reports%20and%20Data/Historical%20Trends/Historical_Trends_2020.pdf). You'll want to download it to a place you'll remember (like your Downloads folder, or the labs folder in your repository). The goal is to write a couple of paragraphs that summarize the changes in various health metrics and to find a possible story about recent changes.

## Setup Tabula

Start Tabula, then go to http://127.0.0.1:8080/ in your browser. Click the "Browse" button and find the PDF file and click "open", and then click the "Import button" in Tabula. This will take a few seconds.

This PDF has a single table spread over two pages to extract. We're going to make a single dataframe from this table, exporting it to a CSV file that you will load into R. In Tabula, draw a box around the table and click the "Preview & Export Extracted Data" button. You may want to play with including or excluding the column headers.

Save the CSV (it should be called `tabula-Historical_Trends_2020.csv` by default) to your lab_05/data folder.

From there, you will need to read in the data, and add or fix headers if necessary. You can choose to include the headers from the PDF in your exported CSV files OR to exclude them and add them when importing. `read_csv` allows us to do this ([and more](https://readr.tidyverse.org/reference/read_delim.html)).

## Load and clean up the data in R

You will need to read in and clean up the data so that it can be used for analysis. By "clean" I mean the column headers should not contain spaces and they should have meaningful names, not "x1" or something similar. How you do that is up to you (and could involve something outside R), but you can use select() with or without the minus sign to include or exclude certain columns. You also can use the `rename` function to, well, rename columns. Importantly, you'll need to ensure that the columns containing numbers actually have a numeric datatype. There is a way to do this that doesn't require typing each column name; you don't have to use it but it involves the `across` function.

Also: you may not need every column if some are duplicated!

```{r}
md_health_trends <- read_csv("data/tabula-Historical_Trends_2020.csv", col_names = FALSE)

md_health_trends <- md_health_trends %>% 
  rename(year = X1, total_pop = X2, pop65_plus = X3, births = X4, birth_rate = X5, pct_teen_births = X6, pct_low_birth_weight = X7, pct_prenatal_care = X8, 
         deaths = X10, crude_death_rate = X11, infant_deaths = X12, infant_death_rate = X13, life_expectancy = X14, leading_cause = X15, heart_disease_deaths = X16,
         heart_disease_rate = X17, malignant_neoplasm_deaths = X18, malignant_neoplasms_rate = X19, cerebrovascular_deaths = X20, cerebrovascular_rate = X21,
         chronic_lower_resp_deaths = X22, chronic_lower_resp_rate = X23, diabetes_deaths = X24, diabetes_rate = X25) %>% 
  select(-X9) %>% 
  mutate(across(c(-"leading_cause"), ~as.numeric(gsub(",","",.x))))

```

## Answer questions

Q1.

A1.

```{r}
current_sep22 <- current_sep22 %>% 
  mutate(pct_dem22 = (dem22/total22)*100, pct_rep22 = (rep22/total22)*100, pct_unaffil22 = (unaf22/total22)*100)

current_sep20 <- current_sep20 %>% 
  mutate(pct_dem20 = (dem/total)*100, pct_rep20 = (rep/total)*100, pct_unaffil20 = (unaf/total)*100)

current_compare <- current_sep22 %>% 
  left_join(current_sep20, by='county') %>% 
  mutate(dem_pct_change = (dem22-dem)/dem*100, rep_pct_change = (rep22-rep)/rep*100, unaffil_pct_change = (unaf22-unaf)/unaf*100)
```

Q2. Among the Maryland jurisdictions with the most registered voters, which one had the biggest percentage increase in unaffiliated voters between 2020 and 2022? How did that county vote for governor in 2018 and for president in 2020? Contrast the partisan percentages of that county with the county that had the second-largest percentage increase in unaffiliated voters. You should display information from the data that shows the counties with the largest percentage increase first.

A2. Frederick County had the largest percentage increase, 13.2 percent. Republican Gov. Larry Hogan [won 67% of the vote in 2018 in Frederick](https://www.elections.maryland.gov/elections/2018/results/general/gen_results_2018_2_by_county_11-1.html), while [Joe Biden won the county with 53.3% of the vote in 2020](https://www.elections.maryland.gov/elections/2020/results/general/gen_results_2020_4_by_county_11-1.html).

Frederick County's partisan split is much narrower than Prince George's County, which had the second-largest percentage increase in unaffiliated voters. But Frederick is slowly trending Democratic, with 39% of current voters there choosing that party, while Prince George's is actually losing Democratic voters.

```{r}
current_compare %>% 
  filter(total22 > 100000) %>% 
  arrange(desc(unaffil_pct_change))
```

Q3. Do the party percentages of new registrants (% Dem, % Rep, % Unaffiliated) from September 2022 and September 2020 match the overall percentage of partisan registration in the state at those times?

In other words, did new registrants mirror the overall partisan composition of the electorate, or were they different? Do any of the methods of registration vary significantly from the overall partisan pattern? Which method is worthy of further exploration?

A3. Overall, in September 2022 and September 2020, the statewide partisan was roughly 54-24-20 D/R/I, and September registrations in both years are somewhat consistent with that, but with much higher figures for unaffiliated voters (25-30%). Republican registrations in September 2022 were 15% of the total, down from 20% in September 2020, suggesting a drop in GOP enthusiasm/effort. A third of new voters who registered at the MVA in September 2022 were unaffiliated, and Democrats who registered this way were 49%. Registration by mail is down among Republicans compared to 2020, which probably is due to COVID's impact on 2020 and general skepticism among conservatives about the method.

```{r}
new_registrations_sep22 <- new_registrations_sep22 %>% 
  mutate(pct_dem22 = (dem/total)*100, pct_rep22 = (rep/total)*100, pct_unaffil22 = (unaf/total)*100)

new_registrations_sep20 <- new_registrations_sep20 %>% 
  mutate(pct_dem20 = (dem/total)*100, pct_rep20 = (rep/total)*100, pct_unaffil20 = (unaf/total)*100)
```

Q4. Choose your own adventure! Using both the 2022 and 2020 data for one of the dataframes (changes, removals or new registrations), ask and answer a question that makes at least one comparison and requires code to answer. That could involve calculating a percentage, percentage change or the raw difference between two columns.

A4.

```{r}

```

Q5. What's the best story idea or question you've seen as a result of the work you've done in this lab?

A5.
